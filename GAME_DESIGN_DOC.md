# 文明：奥德赛 (Civilization: Odyssey) - 开发文档

> **当前版本**: v0.2.0 (Phase 1: 部落时代 - Alpha)
> **最后更新**: 2025-01-07
> **开发状态**: 核心循环已实现，平衡性调整阶段

---

## 目录
1. [核心理念](#1-核心理念)
2. [已实现功能清单](#2-已实现功能清单)
3. [技术架构](#3-技术架构)
4. [游戏系统详解](#4-游戏系统详解)
5. [平衡性模型](#5-平衡性模型)
6. [基础牢靠性分析](#6-基础牢靠性分析)
7. [下一步开发计划](#7-下一步开发计划)

---

## 1. 核心理念

### 范式转移 (The Paradigm Shift)
与传统的"数值无限膨胀"类挂机游戏不同，本作的核心在于**"时代更迭"**。

每一个时代（Era）不仅是更换资源名称，而是彻底改变核心互动机制：

- **Era 1: 部落时代 (生存)** - _Man vs Nature_
  - 核心体验：**微操与紧迫感**
  - 玩家对抗"季节"系统，夏季储备食物度过严冬
  - 失败条件：食物耗尽 → 人口死亡

- **Era 2: 王国时代 (秩序)** - _Order vs Chaos_ (未实现)
  - 核心体验：**平衡与管理**
  - 引入"幸福度"与"政策"系统

- **Era 3: 帝国时代 (征服)** - _Us vs Them_ (未实现)
  - 核心体验：**博弈与战略**
  - 引入"敌对文明"与"后勤线"

- **Era 4: 星际时代 (飞升)** - _Matter vs Energy_ (未实现)
  - 核心体验：**规模化与物理法则**
  - 引入"质能转换"与"戴森球"

---

## 2. 已实现功能清单

### ✅ Phase 1.0: 基础系统 (已完成)

#### 资源系统
- [x] **6 种资源**: 浆果、木材、毛皮、石料、理念、人口
- [x] **存储上限机制** (理念除外)
- [x] **Decimal.js 精确数值计算** (防止浮点误差)
- [x] **资源溢出保护** (超过上限自动丢弃)

#### 游戏循环
- [x] **固定时间步长**: 10 TPS (Ticks Per Second)
- [x] **暂停/继续/加速**: 1x, 2x, 5x 速度控制
- [x] **自动保存**: (规划中)

#### UI 组件
- [x] **响应式布局**: 3 列网格设计 (左中右)
- [x] **深色模式**: 完整支持
- [x] **实时更新**: 200ms 轮询机制
- [x] **日志系统**: 带颜色编码的事件记录

---

### ✅ Phase 1.1: 季节与生存 (已完成)

#### 季节系统
- [x] **4 季节循环**: 春 → 夏 → 秋 → 冬
- [x] **季节长度**: 每季 10 天 (100 ticks)
- [x] **季节修正**:
  - 春/夏: 食物/木材产出 +100%
  - 秋: 正常产出
  - 冬: 食物产出 -90%

#### 篝火系统
- [x] **核心生存机制**: 篝火熄灭 = 效率 -90%
- [x] **燃料消耗**: 1.0 木材/秒 (冬季 2.0)
- [x] **自动加柴**: 可开关的自动添加功能
- [x] **状态显示**: 正常/低燃料/熄灭
- [x] **冬季惩罚**: 无篝火 → 人口冻死

#### 人口系统
- [x] **自然增长**: 有盈余食物时自动增加
- [x] **饥饿机制**: 食物耗尽 → 人口死亡
- [x] **最大人口限制**: 通过建筑提升
- [x] **死亡惩罚**: 饥饿/冻结导致人口减少

---

### ✅ Phase 1.2: 职业与自动化 (已完成)

#### 职业系统
- [x] **3 种职业**:
  - 🍎 **采集者**: 产出食物 (3.0/秒)
  - 🪓 **伐木工**: 产出木材 (0.5/秒)
  - ⛏️ **碎石工**: 产出石料 (0.1/秒, 需解锁)

- [x] **职业分配 UI**:
  - +/- 按钮分配/移除工人
  - 实时显示职业人口
  - 闲置人口统计

- [x] **闲置人口效果**:
  - 产出"理念" (0.02/秒/人)
  - 显示为"闲置 / 思考者"

#### 科技系统
- [x] **3 项科技**:
  1. **打制石器** (70 理念 + 20 石料)
     - 解锁碎石工职业
     - 手动采集石料翻倍

  2. **石斧** (200 理念 + 50 木材 + 30 石料)
     - 木材产量翻倍
     - 手动伐木翻倍

  3. **长矛** (180 理念 + 40 木材)
     - 食物产量 1.5 倍
     - 毛皮掉落率翻倍

- [x] **科技树 UI**:
  - 显示成本与效果
  - 资源不足时红色警告
  - "已掌握"分区展示

---

### ✅ Phase 1.3: 动态平衡模型 (已完成)

#### 黄金比例系统
- [x] **采集者产出**: 3.0 食物/秒
- [x] **基础消耗**: 1.0 食物/秒/人
- [x] **净盈余**: 1 采集者 = 养活 3 人 (自己 + 2 人)

#### 动态食物消耗
- [x] **季节修正**:
  - 春/夏: 1.0x
  - 秋: 1.1x (开始变冷)
  - 冬: 2.0x (严寒)

- [x] **温暖修正** (冬季减法叠加):
  - 篝火点燃: -0.5
  - 有衣物: -0.3
  - 最小值: 1.0

#### 衣物系统
- [x] **判定逻辑**: `毛皮数量 >= 人口数量`
- [x] **效果**: 减少冬季食物消耗 30%
- [x] **不衰减**: 毛皮不会自动消失

#### 食物状态面板
- [x] **净变化显示**: 绿色正数/红色负数
- [x] **产出/消耗分解**: 实时显示
- [x] **寒冷警告**: 仅秋/冬季显示
- [x] **温暖状态**: 篝火 + 衣物状态图标

---

### ✅ Phase 1.4: 行动与交互 (已完成)

#### 手动采集
- [x] **采集浆果**: 5 浆果/次 (3s CD)
- [x] **伐木**: 3 木材/次 (3s CD)
- [x] **狩猎**: 2 浆果 + 1 毛皮/次 (3s CD)
- [x] **独立冷却**: 每个动作独立计时
- [x] **冷却倒计时**: 按钮上显示剩余时间

#### 议事场 (主动玩法)
- [x] **成本**: 5 浆果
- [x] **奖励**: 15 理念
- [x] **冷却**: 30 秒
- [x] **UI**: 紫色主题按钮，带倒计时

#### 荒野探索
- [x] **成本**: 50 浆果
- [x] **冷却**: 5 秒
- [x] **随机结果**:
  - 60%: 无收获
  - 30%: 发现资源 (5-15 木材/石料)
  - 10%: 发现幸存者 (+1 人口)

---

### ✅ Phase 1.5: 建筑 (已完成)

#### 已实现建筑
- [x] **帐篷**: +5 最大人口
- [x] **粮仓**: +100 食物存储
- [x] **木材场**: +100 木材存储
- [x] **毛皮棚**: +50 毛皮存储
- [x] **石料场**: +50 石料存储

#### 建筑系统
- [x] **成本递增**: 每次建造价格增加
- [x] **资源检查**: 不足时禁用按钮
- [x] **实时更新**: 建造后立即生效

---

## 3. 技术架构

### 技术栈
```typescript
- 框架: React 19 + Vite
- 语言: TypeScript 5.x
- 样式: Tailwind CSS
- 状态管理: Zustand (Slice 模式)
- 数值计算: Decimal.js
- 图标: Lucide React
```

### 项目结构
```
src/
├── components/          # UI 组件
│   ├── ActionPanel.tsx          # 手动操作
│   ├── BonfirePanel.tsx         # 篝火管理
│   ├── BuildingsPanel.tsx       # 建造系统
│   ├── FoodStatusPanel.tsx      # 食物平衡
│   ├── LogPanel.tsx             # 日志窗口
│   ├── PopulationInfo.tsx       # 人口信息
│   ├── ResourcePanel.tsx        # 资源显示
│   ├── SeasonDisplay.tsx        # 季节进度
│   ├── TribalManagementPanel.tsx # 职业分配
│   └── TechTreePanel.tsx        # 科技树
│
├── store/
│   ├── slices/          # Zustand 切片
│   │   ├── resourceSlice.ts    # 资源管理
│   │   ├── seasonSlice.ts      # 季节系统
│   │   ├── populationSlice.ts  # 人口逻辑
│   │   ├── bonfireSlice.ts     # 篝火系统
│   │   ├── buildingsSlice.ts   # 建筑系统
│   │   ├── tribeSlice.ts       # 职业系统
│   │   ├── techSlice.ts        # 科技系统
│   │   ├── logSlice.ts         # 日志系统
│   │   └── scoutingSlice.ts    # 探索系统
│   ├── useGameStore.ts         # Store 组合
│   └── types.ts                # 类型定义
│
├── game/
│   └── tick.ts                 # 游戏主循环
│
├── types/
│   └── game.ts                 # 游戏类型定义
│
└── hooks/
    └── useGameLoop.ts          # 游戏循环 Hook
```

### 核心设计模式

#### 1. Slice 模式 (Zustand)
每个系统独立管理，通过 `useGameStore` 组合：
```typescript
export const useGameStore = create<GameStore>()((set, get, api) => ({
  ...createResourceSlice(set, get, api),
  ...createSeasonSlice(set, get, api),
  ...createTribeSlice(set, get, api),
  // ...
}));
```

#### 2. 固定时间步长 (Fixed Time Step)
```typescript
const FPS = 10; // 10 TPS
const tickRate = 1000 / FPS; // 100ms per tick

setInterval(() => {
  gameTick(); // 精确控制游戏逻辑
}, tickRate);
```

#### 3. Decimal.js 精确计算
```typescript
// ❌ 禁止: JS Number
const result = 0.1 + 0.2; // 0.30000000000000004

// ✅ 正确: Decimal.js
const result = new Decimal(0.1).plus(0.2); // 0.3
```

#### 4. 轮询架构 (Polling)
UI 组件每 200ms 轮询 Store 状态：
```typescript
useEffect(() => {
  const interval = setInterval(() => {
    const state = useGameStore.getState();
    setResource(state.resources.food);
  }, 200);
  return () => clearInterval(interval);
}, []);
```

---

## 4. 游戏系统详解

### 4.1 季节系统

#### 季节循环
```
春 (10天) → 夏 (10天) → 秋 (10天) → 冬 (10天) → 循环
```

#### 产出修正
| 季节 | 食物修正 | 木材修正 | 备注 |
|------|----------|----------|------|
| 春 | 1.5x | 1.5x | 万物复苏 |
| 夏 | 1.5x | 1.5x | 产出高峰 |
| 秋 | 1.0x | 1.0x | 最后储备期 |
| 冬 | 0.1x | 1.0x | 严酷寒冬 |

#### 消耗修正
| 季节 | 基础消耗 | 篝火 | 衣物 | 最终 |
|------|----------|------|------|------|
| 春/夏 | 1.0x | - | - | 1.0x |
| 秋 | 1.0x | - | - | 1.1x |
| 冬 (最糟) | 2.0x | -0.5 | -0.3 | 2.0x |
| 冬 (有火) | 2.0x | -0.5 | - | 1.5x |
| 冬 (火+皮) | 2.0x | -0.5 | -0.3 | 1.2x |

### 4.2 篝火系统

#### 状态机
```
燃烧 (正常) → 低燃料 (<30) → 熄灭 (0)
     ↑            ↓               ↓
     └──────────── 加柴 ←──────────┘
```

#### 燃料消耗
```typescript
基础消耗: 0.1 木材/刻 (1.0/秒)
冬季消耗: 0.2 木材/刻 (2.0/秒)
最大燃料: 100
```

#### 效率惩罚
```typescript
if (篝火熄灭) {
  所有资源产出 *= 0.1; // 90% 惩罚
  理念产出 *= 0.5; // 50% 惩罚
}
```

### 4.3 职业系统

#### 职业产出
| 职业 | 产出/秒 | 解锁条件 | 备注 |
|------|---------|----------|------|
| 采集者 | 3.0 食物 | 默认 | 黄金比例 1:3 |
| 伐木工 | 0.5 木材 | 默认 | 2人=1篝火 |
| 碎石工 | 0.1 石料 | 打制石器 | 需科技解锁 |
| 思考者 | 0.02 理念 | 闲置 | 自动产出 |

#### 科技加成
```typescript
// 石斧科技
if (已研究石斧) {
  伐木工产出 *= 2.0;
  手动伐木 *= 2.0;
}

// 长矛科技
if (已研究长矛) {
  采集者产出 *= 1.5;
  手动采集 *= 1.5;
  毛皮掉落率 *= 2.0;
}
```

### 4.4 科技系统

#### 科技树
```
打制石器 (70理念 + 20石料)
  ↓
  ├→ 解锁碎石工
  └→ 手动采石 x2

石斧 (200理念 + 50木材 + 30石料)
  ↓
  ├→ 伐木工 x2
  └→ 手动伐木 x2

长矛 (180理念 + 40木材)
  ↓
  ├→ 采集者 x1.5
  ├→ 手动采集 x1.5
  └→ 毛皮掉落率 x2
```

### 4.5 食物平衡模型

#### 黄金比例公式
```typescript
净食物变化 = (采集者 × 3.0) - (人口 × 季节修正 × 温暖修正)
```

#### 平衡示例
| 场景 | 采集者 | 人口 | 消耗 | 产出 | 净值 |
|------|--------|------|------|------|------|
| 春季初始 | 2 | 5 | 5.0 | 6.0 | +1.0 ✅ |
| 冬季无火 | 2 | 5 | 10.0 | 6.0 | -4.0 ❌ |
| 冬季有火 | 3 | 5 | 7.5 | 9.0 | +1.5 ✅ |
| 冬季完美 | 2 | 5 | 6.0 | 6.0 | 0.0 (需火+皮) |

---

## 5. 平衡性模型

### 5.1 核心数值

#### 资源产出率
```typescript
// 职业产出 (每秒)
GATHERER_BASE_RATE = 3.0    // 采集者
WOODCUTTER_BASE_RATE = 0.5  // 伐木工
STONECUTTER_BASE_RATE = 0.1 // 碎石工

// 闲置产出 (每秒)
IDEAS_PER_IDLE_SETTLER = 0.02
```

#### 资源消耗率
```typescript
// 人口消耗 (每秒)
FOOD_PER_PERSON = 1.0  // 基础
WINTER_MULTIPLIER = 2.0 // 冬季

// 篝火消耗 (每秒)
BONFIRE_CONSUMPTION = 1.0  // 春/夏/秋
BONFIRE_WINTER = 2.0       // 冬季
```

### 5.2 游戏节奏

#### 前期节奏 (0-10 分钟)
- [x] 初始 5 人口 + 50 浆果
- [x] 分配 2 采集者 → 净 +1.0 食物/秒
- [x] 手动采集过渡
- [x] 目标：存活过第一个冬天

#### 中期节奏 (10-30 分钟)
- [x] 人口增长至 10-15
- [x] 解锁第一个科技 (打制石器)
- [x] 建造粮仓/木材场
- [x] 目标：建立稳定食物循环

#### 后期节奏 (30+ 分钟)
- [x] 研究所有科技
- [x] 人口增长至 20+
- [x] 探索荒野寻找幸存者
- [x] 目标：达成人口上限

---

## 6. 基础牢靠性分析

### ✅ 已验证的坚实基础

#### 1. 数值系统 ⭐⭐⭐⭐⭐
**状态**: 完全牢靠
- Decimal.js 全覆盖
- 无浮点误差
- 支持极大数值（未来扩展）
- **结论**: 可作为 Era 2-4 的基础

#### 2. 状态管理 ⭐⭐⭐⭐⭐
**状态**: 完全牢靠
- Slice 模式解耦完美
- 易于添加新系统
- 类型安全
- **结论**: 可直接扩展至 Era 2

#### 3. 游戏循环 ⭐⭐⭐⭐⭐
**状态**: 完全牢靠
- 固定时间步长精确
- 暂停/加速功能完善
- Tick 逻辑清晰
- **结论**: 可支持更复杂的系统

#### 4. UI 架构 ⭐⭐⭐⭐
**状态**: 良好，有改进空间
- 响应式布局完善
- 轮询机制稳定
- 深色模式完整
- **潜在问题**: 面板过多导致界面拥挤
- **建议**: Era 2 考虑标签页 (Tab) 系统

#### 5. 季节系统 ⭐⭐⭐⭐⭐
**状态**: 完全牢靠
- 核心循环稳定
- 惩罚机制合理
- **结论**: 可作为 Era 1 标志性机制

### ⚠️ 需要巩固的部分

#### 1. 平衡性 ⭐⭐⭐
**状态**: 基本平衡，需要调优
- ✅ 黄金比例合理 (1:3)
- ⚠️ 冬季可能过难 (2.0x 消耗)
- ⚠️ 科技成本需要测试
- **建议**: 增加难度选择 (简单/普通/困难)

#### 2. 早期游戏体验 ⭐⭐⭐
**状态**: 可玩，但引导不足
- ❌ 无新手教程
- ❌ 无目标提示
- ❌ 失败反馈不明显
- **建议**: 添加"任务系统"引导玩家

#### 3. 后期内容 ⭐⭐
**状态**: 不足
- ❌ 研究完所有科技后目标缺失
- ❌ 无长期目标 (人口 100+?)
- **建议**: 添加里程碑系统

### 🔧 技术债务

#### 1. 测试覆盖
**当前**: 0% 自动测试
**建议**: 至少添加核心计算的单元测试
```typescript
describe('Food Consumption', () => {
  it('should calculate winter consumption correctly', () => {
    // ...
  });
});
```

#### 2. 性能优化
**当前**: 200ms 轮询可能浪费
**建议**: 考虑使用 Zustand 订阅
```typescript
// 替代轮询
const food = useGameStore(state => state.resources.food);
```

#### 3. 错误处理
**当前**: try-catch 忽略错误
**建议**: 添加全局错误边界
```typescript
<ErrorBoundary>
  <App />
</ErrorBoundary>
```

---

## 7. 下一步开发计划

### Phase 1.6: 优化与打磨 (当前优先级)

#### 用户体验
- [ ] **新手教程**: 引导玩家首次游戏
- [ ] **任务系统**: 短期目标 (存活 1 年/人口 10/研究科技)
- [ ] **成就系统**: 长期目标
- [ ] **音效**: 季节切换/按钮点击

#### 平衡性调整
- [ ] **难度选择**: 简单/普通/困难
- [ ] **数值微调**: 根据玩家反馈调整
- [ ] **季节数值**: 可能降低冬季惩罚

#### UI 改进
- [ ] **标签页系统**: 组织过多面板
- [ ] **工具提示**: 悬停显示详细信息
- [ ] **设置面板**: 游戏速度/音量/主题

---

### Phase 1.7: 内容扩展 (短期)

#### 新建筑
- [ ] **陷阱**: 自动狩猎
- [ ] **晾肉架**: 食物储存升级
- [ ] **集会所**: 理念产出加成

#### 新科技
- [ ] **弓箭**: 狩猎效率提升
- [ ] **农业**: 解锁农田
- [ ] **储存技术**: 所有存储上限 +50%

#### 新机制
- [ ] **事件系统**: 随机事件 (狼群袭击/发现浆果丛)
- [ ] **交易**: 与流浪商人交易
- [ ] **天赋系统**: 每次升级选择加成

---

### Phase 2.0: 王国时代 (中期，1-2个月)

#### 核心变更
- [ ] **政治系统**: 部落 → 王国转型
- [ ] **幸福度**: 新资源类型
- [ ] **税收系统**: 可调节税率
- [ ] **政策树**: 3-5 条分支

#### 新资源
- [ ] **黄金**: 货币系统
- [ ] **矿石**: 军事建筑需要
- [ ] **幸福度**: 核心限制资源

#### 新建筑
- [ ] **房屋**: 提供幸福度
- [ ] **市场**: 交易资源
- [ ] **兵营**: 训练军队
- [ ] **图书馆**: 产生科技点

#### UI 变更
- [ ] **政策面板**: 滑块调节税率
- [ ] **幸福度面板**: 显示满意度
- [ ] **3D 视图**: 可能的城邦可视化

---

## 8. 开发日志

### v0.2.0 (2025-01-07) - 平衡性重构
**重大变更**:
- ✅ 实现黄金比例模型 (1:3)
- ✅ 动态食物消耗 (季节+温暖)
- ✅ 衣物系统
- ✅ 食物状态面板
- ✅ 篝火消耗调整 (1.0/秒)

**文件修改**:
- `tribeSlice.ts`: 添加动态消耗计算
- `bonfireSlice.ts`: 调整篝火消耗
- `tick.ts`: 移除旧消耗逻辑
- `FoodStatusPanel.tsx`: 新增组件

### v0.1.5 (2025-01-07) - 职业与科技
**新增功能**:
- ✅ 职业系统 (采集者/伐木工/碎石工)
- ✅ 科技树 (3 项科技)
- ✅ 议事场 (主动玩法)
- ✅ 部落管理面板
- ✅ 科技树面板

### v0.1.0 (2025-01-06) - 基础循环
**初始版本**:
- ✅ 季节系统
- ✅ 篝火系统
- ✅ 人口系统
- ✅ 资源采集
- ✅ 建筑 (5 种)

---

## 9. 性能指标

### 当前性能
- **帧率**: 稳定 60 FPS
- **内存**: ~50MB (初始)
- **包大小**: ~500KB (gzipped)
- **Tick 时间**: <1ms

### 目标性能 (Era 2)
- **帧率**: 保持 60 FPS
- **内存**: <100MB
- **Tick 时间**: <5ms (更复杂逻辑)

---

## 10. 已知问题

### Bug 列表
- [ ] 伐木工和采集者无法分配 (已修复 ✅)
- [ ] 自动加储可能失效 (已修复 ✅)
- [ ] 冬季人口可能异常死亡 (待验证)

### UI 问题
- [ ] 移动端布局未优化
- [ ] 面板过多导致拥挤
- [ ] 无加载动画

### 平衡性问题
- [ ] 冬季可能过难
- [ ] 科技成本需要测试
- [ ] 后期目标缺失

---

## 结论

### 当前基础牢靠性评分: ⭐⭐⭐⭐ (4/5)

**优点**:
1. ✅ 数值系统完全牢靠 (Decimal.js)
2. ✅ 状态管理架构优秀 (Zustand Slice)
3. ✅ 游戏循环精确稳定
4. ✅ 核心机制完整 (季节/篝火/职业)

**需要改进**:
1. ⚠️ 平衡性需要更多测试
2. ⚠️ 后期内容不足
3. ⚠️ 新手引导缺失

### 能否开始 Era 2 开发?

**评估**: ✅ **可以，但建议先完成 Phase 1.6**

**理由**:
1. 基础架构完全支持扩展
2. 核心循环已经稳定
3. 技术债务可控

**建议**:
1. 先完成 Phase 1.6 (优化+打磨)
2. 收集玩家反馈
3. 调整平衡性
4. **然后**开始 Era 2 开发

---

**文档维护**: 请在每次重大更新后同步更新此文档
**最后审查**: 2025-01-07
**下次审查**: Phase 1.6 完成后
